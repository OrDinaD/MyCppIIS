name: ðŸŽ iOS Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  XCODE_VERSION: '16.0'
  IOS_DESTINATION: 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.1'

jobs:
  build-and-test:
    name: ðŸ”¨ Build & Test iOS App
    runs-on: macos-15
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: ðŸ” Verify Xcode Installation
      run: |
        xcodebuild -version
        xcrun simctl list devices
        
    - name: ðŸ“± List Available Simulators
      run: xcrun simctl list devices available
      
    - name: ðŸ§¹ Clean Build Directory
      run: |
        rm -rf ~/Library/Developer/Xcode/DerivedData/*
        xcodebuild clean -project cPPiIS.xcodeproj
        
    - name: ðŸ”¨ Build iOS App
      run: |
        xcodebuild build \
          -project cPPiIS.xcodeproj \
          -scheme cPPiIS \
          -destination "${{ env.IOS_DESTINATION }}" \
          -configuration Debug \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: ðŸ§ª Run Unit Tests (if any)
      run: |
        xcodebuild test \
          -project cPPiIS.xcodeproj \
          -scheme cPPiIS \
          -destination "${{ env.IOS_DESTINATION }}" \
          -configuration Debug \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
      continue-on-error: true
      
    - name: ðŸ“Š Analyze Code
      run: |
        xcodebuild analyze \
          -project cPPiIS.xcodeproj \
          -scheme cPPiIS \
          -destination "${{ env.IOS_DESTINATION }}" \
          -configuration Debug \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

  cpp-analysis:
    name: ðŸ” C++ Code Analysis
    runs-on: macos-15
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup Clang Tools
      run: |
        brew install llvm
        echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
        
    - name: ðŸ” C++ Static Analysis
      run: |
        find cPPiIS/Core -name "*.cpp" -o -name "*.hpp" | xargs clang-tidy --checks="-*,readability-*,performance-*,modernize-*" || true
        
    - name: ðŸ§¹ C++ Format Check
      run: |
        find cPPiIS/Core -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror || true

  api-testing:
    name: ðŸŒ API Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ðŸ§ª Run API Tests
      run: |
        python test_api.py || echo "API tests completed"
        python test_api_detailed.py || echo "Detailed API tests completed"
      continue-on-error: true

  documentation:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ” Check Documentation
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
        test -f README.md || { echo "âŒ README.md missing"; exit 1; }
        test -f .github/CONTRIBUTING.md || { echo "âŒ CONTRIBUTING.md missing"; exit 1; }
        test -f .github/CODE_OF_CONDUCT.md || { echo "âŒ CODE_OF_CONDUCT.md missing"; exit 1; }
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ README
        grep -q "cPPiIS" README.md || { echo "âŒ Project name not found in README"; exit 1; }
        grep -q "ÐžÐžÐŸ" README.md || { echo "âŒ OOP reference not found in README"; exit 1; }
        
        echo "âœ… Documentation check passed"

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ” Scan for Secrets
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if grep -r -i "password\s*=" cPPiIS/ --exclude-dir=.git --exclude="*.md" | grep -v "//.*password" | grep -v "/\*.*password.*\*/" ; then
          echo "âš ï¸ Warning: Found potential hardcoded passwords"
        fi
        
        if grep -r -i "api_key\s*=" cPPiIS/ --exclude-dir=.git --exclude="*.md"; then
          echo "âš ï¸ Warning: Found potential hardcoded API keys"
        fi
        
        echo "âœ… Security scan completed"

  build-summary:
    name: ðŸ“‹ Build Summary
    needs: [build-and-test, cpp-analysis, api-testing, documentation, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Summary Report
      run: |
        echo "## ðŸŽ iOS Build & Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| iOS Build & Test | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| C++ Analysis | ${{ needs.cpp-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| API Testing | ${{ needs.api-testing.result == 'success' && 'âœ… Passed' || 'âš ï¸ Completed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation | ${{ needs.documentation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ“ Educational Project Status" >> $GITHUB_STEP_SUMMARY
        echo "This is a coursework project demonstrating OOP principles in C++." >> $GITHUB_STEP_SUMMARY